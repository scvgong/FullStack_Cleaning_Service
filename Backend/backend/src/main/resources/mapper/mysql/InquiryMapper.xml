<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- resources/mapper/InquiryMapper.xml -->
<mapper namespace="com.cleaning.backend.mapper.InquiryMapper">
    <insert id="insert" parameterType="com.cleaning.backend.dto.InquiryRequestDto">
        INSERT INTO inquiry (business_id, subject, message)
        VALUES (#{businessId}, #{subject}, #{message})
    </insert>

    <select id="findAllPending" resultType="com.cleaning.backend.model.Inquiry">
        SELECT
            i.id,
            i.business_id AS businessId,
            bu.username AS businessName,
            i.subject,
            i.message,
            i.status,
            i.created_at AS createdAt
        FROM inquiry i
        LEFT JOIN business_user bu on i.business_id = bu.id
        WHERE status = 'PENDING'
        ORDER BY i.created_at DESC
    </select>

    <!-- 사업자별 목록 조회 -->
    <select id="findAllByBusiness" resultMap="InquiryResult">
        SELECT
        i.id,
        i.business_id       AS businessId,
        bu.username         AS businessName,
        i.subject,
        i.message,
        i.status,
        i.created_at        AS createdAt,
        r.replied_at        AS repliedAt
        FROM inquiry i
        JOIN business_user bu
        ON i.business_id = bu.id
        LEFT JOIN inquiry_reply r
        ON r.inquiry_id = i.id
        WHERE i.business_id = #{businessId}
        ORDER BY i.created_at DESC
    </select>
    <!-- 단일 조회 -->
    <select id="findById" resultType="com.cleaning.backend.model.Inquiry">
        SELECT
        i.id,
        i.business_id       AS businessId,
        bu.username         AS businessName,
        i.subject,
        i.message,
        i.status,
        i.created_at        AS createdAt,
        r.replied_at        AS repliedAt
        FROM inquiry i
        JOIN business_user bu
        ON i.business_id = bu.id
        LEFT JOIN inquiry_reply r
        ON r.inquiry_id = i.id
        WHERE i.id = #{id}
    </select>

    <!-- resultMap 정의도 함께 확인하세요 -->
    <resultMap id="InquiryResult" type="com.cleaning.backend.model.Inquiry">
        <id     column="id"           property="id" />
        <result column="business_id"  property="businessId"/>
        <result column="business_name" property="businessName"/>
        <result column="subject"      property="subject"/>
        <result column="message"      property="message"/>
        <result column="status"       property="status"/>
        <result column="createdAt"    property="createdAt"/>
        <result column="repliedAt"    property="repliedAt"/>
    </resultMap>

    <update id="updateStatus">
        UPDATE inquiry
        SET status = #{status}
        WHERE id = #{id}
    </update>
</mapper>
